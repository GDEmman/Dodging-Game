[gd_scene load_steps=8 format=3 uid="uid://cmx1wmwpxb5b0"]

[ext_resource type="Texture2D" uid="uid://v1xw606vw6v5" path="res://ball.png" id="1_x8fbi"]

[sub_resource type="GDScript" id="GDScript_ck66d"]
resource_name = "Ball"
script/source = "extends Area2D

var speed = 400.0
var direction = Vector2.ZERO
var player = null

# --- NEW: Add these so the Main script doesn't crash ---
var is_swerving = false
var is_uturn = false
var is_combined_type = false

# Animation/Movement helpers
var time_passed = 0.0
var velocity_multiplier = 1.0
var has_passed_player = false

func _ready():
	player = get_tree().get_first_node_in_group(\"player\")
	add_to_group(\"balls\")

func _process(delta):
	time_passed += delta
	
	# --- Case 1: Combined Elite Ball (Swerve + U-Turn) ---
	if is_combined_type and player:
		handle_combined_movement(delta)
		
	# --- Case 2: Just U-Turn ---
	elif is_uturn:
		velocity_multiplier = move_toward(velocity_multiplier, -1.5, delta * 1.2)
		position += direction * (speed * velocity_multiplier) * delta
		
	# --- Case 3: Just Swerving ---
	elif is_swerving:
		var side_dir = Vector2(-direction.y, direction.x)
		var swerve = side_dir * cos(time_passed * 6.0) * 150.0
		position += (direction * speed + swerve) * delta
		
	# --- Case 4: Normal Ball ---
	else:
		position += direction * speed * delta

# Helper function for the Elite Ball
func handle_combined_movement(delta):
	var dist = global_position.distance_to(player.global_position)
	if dist < 50: has_passed_player = true
	
	if has_passed_player:
		velocity_multiplier = move_toward(velocity_multiplier, -1.8, delta * 2.0)
	
	var side_dir = Vector2(-direction.y, direction.x)
	var swerve = side_dir * cos(time_passed * 6.0) * 180.0
	position += (direction * (speed * velocity_multiplier) + swerve) * delta

# This function runs when the ball hits something
func _on_body_entered(body):
	if body.has_method(\"take_damage\"):
		body.take_damage(10) # Call the function we wrote earlier
		queue_free() # Destroy the ball after hitting the player

func _on_visible_on_screen_notifier_2d_screen_exited():
	queue_free() # Destroy the ball if it misses the player to save memory

# Inside Ball.gd
func _on_area_entered(area):
	if area.name == \"BaseballBat\":
		var player = get_tree().get_first_node_in_group(\"player\")
		if player and player.is_swinging:
			bounce_away(player.global_position)
	
	# If the ball hits the Player's HitBox instead of the bat
	elif area.name == \"HitBox\":
		# Remove the ball so it doesn't keep damaging the player
		queue_free()

func bounce_away(player_pos):
	# Calculate new direction: directly away from the player's center
	direction = (global_position - player_pos).normalized()
	
	# Give it a speed boost so the hit feels powerful
	speed *= 1.5 
	
	# Visual feedback (flash the ball)
	modulate = Color.YELLOW
	await get_tree().create_timer(0.1).timeout
	modulate = Color.WHITE
"

[sub_resource type="CircleShape2D" id="CircleShape2D_ck66d"]

[sub_resource type="Gradient" id="Gradient_x8fbi"]
offsets = PackedFloat32Array(0.027431421, 0.48877805, 1)
colors = PackedColorArray(0.11033382, 0.11033375, 0, 1, 0.6, 0.6, 0, 1, 1, 0, 0, 1)

[sub_resource type="GradientTexture2D" id="GradientTexture2D_41u45"]
gradient = SubResource("Gradient_x8fbi")
width = 2
height = 2
use_hdr = true
fill = 1
fill_from = Vector2(5, 0)
fill_to = Vector2(0, 5)

[sub_resource type="Gradient" id="Gradient_41u45"]
colors = PackedColorArray(0.76973206, 0.4437441, 3.85046e-07, 1, 0, 0, 0, 0)

[sub_resource type="GradientTexture2D" id="GradientTexture2D_ktgx5"]
gradient = SubResource("Gradient_41u45")
fill = 1
fill_from = Vector2(0.5, 0.5)
fill_to = Vector2(0, 0)

[node name="Ball" type="Area2D" groups=["balls"]]
scale = Vector2(0.2658814, 0.2658814)
collision_layer = 9
collision_mask = 9
script = SubResource("GDScript_ck66d")

[node name="Sprite2D" type="Sprite2D" parent="."]
texture = ExtResource("1_x8fbi")

[node name="CollisionShape2D" type="CollisionShape2D" parent="."]
scale = Vector2(3.3275092, 3.3275092)
shape = SubResource("CircleShape2D_ck66d")

[node name="CPUParticles2D" type="CPUParticles2D" parent="."]
show_behind_parent = true
amount = 100
texture = SubResource("GradientTexture2D_41u45")
lifetime = 2.0
preprocess = 0.85
speed_scale = 19.15
explosiveness = 0.15
randomness = 0.23
emission_shape = 2
emission_sphere_radius = 25.22
gravity = Vector2(0, 0)
linear_accel_max = 1.0
scale_amount_min = 0.05

[node name="PointLight2D" type="PointLight2D" parent="."]
energy = 3.95
texture = SubResource("GradientTexture2D_ktgx5")

[connection signal="area_entered" from="." to="." method="_on_area_entered"]
[connection signal="body_entered" from="." to="." method="_on_body_entered"]
